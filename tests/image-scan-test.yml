name: Test Image Scanning Capability
on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-image-scan-basic:
    runs-on: ubuntu-latest
    name: Test Basic Image Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test basic image scan
        uses: ./
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: us-1
          scan_type: image
          image: nginx:latest
          output_path: ./image-scan-results/
          report_formats: json
          minimum_severity: medium
      
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: image-scan-basic-results
          path: ./image-scan-results/

  test-image-scan-vulnerability-only:
    runs-on: ubuntu-latest
    name: Test Vulnerability-Only Image Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test vulnerability-only scan
        uses: ./
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: us-1
          scan_type: image
          image: alpine:latest
          vulnerability_only: true
          output_path: ./vuln-scan-results/
          report_formats: json,sarif
          minimum_score: 7.0
      
      - name: Upload vulnerability scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: image-scan-vulnerability-results
          path: ./vuln-scan-results/

  test-image-scan-advanced-filtering:
    runs-on: ubuntu-latest
    name: Test Advanced Image Scanning with Filtering
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test advanced filtering options
        uses: ./
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: us-1
          scan_type: image
          image: node:16-alpine
          output_path: ./advanced-scan-results/
          report_formats: json
          minimum_severity: high
          minimum_exprt: medium
          vuln_fixable_only: true
          show_full_description: true
          show_full_detection_details: true
          report_sort_by: severity/desc
          no_color: true
      
      - name: Upload advanced scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: image-scan-advanced-results
          path: ./advanced-scan-results/

  test-image-scan-with-upload:
    runs-on: ubuntu-latest
    name: Test Image Scanning with Upload to Falcon
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test scan with upload to Falcon Console
        uses: ./
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: us-1
          scan_type: image
          image: python:3.9-slim
          upload_results: true
          output_path: ./upload-scan-results/
          report_formats: json
          minimum_severity: low
      
      - name: Upload scan results with upload
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: image-scan-upload-results
          path: ./upload-scan-results/

  test-image-scan-sbom-only:
    runs-on: ubuntu-latest
    name: Test SBOM-Only Image Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test SBOM-only scan
        uses: ./
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: us-1
          scan_type: image
          image: redis:alpine
          sbom_only: true
          output_path: ./sbom-scan-results/
          report_formats: sbom-cylconedx
      
      - name: Upload SBOM scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: image-scan-sbom-results
          path: ./sbom-scan-results/

  test-iac-scan-backward-compatibility:
    runs-on: ubuntu-latest
    name: Test IaC Scanning Backward Compatibility
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test IaC scan (default behavior)
        uses: ./
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: us-1
          path: tests
          output_path: ./iac-scan-results/
          report_formats: json,sarif
          config: tests/config.json
      
      - name: Upload IaC scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: iac-scan-compatibility-results
          path: ./iac-scan-results/

  test-iac-scan-explicit:
    runs-on: ubuntu-latest
    name: Test Explicit IaC Scanning
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test explicit IaC scan
        uses: ./
        with:
          falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
          falcon_region: us-1
          scan_type: iac
          path: tests
          output_path: ./explicit-iac-results/
          report_formats: json
          severities: high,critical
          disable_secrets_scan: false
      
      - name: Upload explicit IaC scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: iac-scan-explicit-results
          path: ./explicit-iac-results/
